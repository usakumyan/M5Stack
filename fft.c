/* fft.c */
//#define M5StackCore2
#ifdef M5StackCore2
#include <M5Core2.h>
#include <drive/i2s.h>
#include "SD.h"
#else
#include <stdio.h>
#include <stdlib.h>
#endif

#include "fft.h"

/* Table of Window function (Hann Window) */
// 0.5 - 0.5cos(2 pi x) where eg=1.0
const DTYPE pWindow[256]={0.000000,0.000016,0.000062,0.000140,0.000248,0.000388,0.000558,0.000759,0.000990,0.001252,0.001544,0.001867,0.002219,0.002601,0.003012,0.003453,0.003922,0.004421,0.004947,0.005502,0.006084,0.006694,0.007330,0.007993,0.008683,0.009398,0.010139,0.010904,0.011694,0.012508,0.013345,0.014205,0.015087,0.015992,0.016918,0.017864,0.018831,0.019817,0.020823,0.021846,0.022888,0.023947,0.025022,0.026113,0.027219,0.028340,0.029475,0.030622,0.031782,0.032954,0.034137,0.035331,0.036534,0.037745,0.038965,0.040192,0.041426,0.042666,0.043911,0.045160,0.046413,0.047669,0.048927,0.050186,0.051446,0.052706,0.053964,0.055221,0.056476,0.057727,0.058974,0.060217,0.061453,0.062684,0.063908,0.065124,0.066331,0.067529,0.068717,0.069895,0.071061,0.072215,0.073356,0.074484,0.075598,0.076696,0.077780,0.078847,0.079897,0.080930,0.081944,0.082940,0.083917,0.084874,0.085810,0.086725,0.087619,0.088490,0.089339,0.090164,0.090966,0.091744,0.092497,0.093225,0.093927,0.094603,0.095253,0.095877,0.096473,0.097041,0.097582,0.098094,0.098578,0.099033,0.099459,0.099856,0.100223,0.100560,0.100868,0.101145,0.101391,0.101608,0.101793,0.101948,0.102072,0.102165,0.102227,0.102258,0.102258,0.102227,0.102165,0.102072,0.101948,0.101793,0.101608,0.101391,0.101145,0.100868,0.100560,0.100223,0.099856,0.099459,0.099033,0.098578,0.098094,0.097582,0.097041,0.096473,0.095877,0.095253,0.094603,0.093927,0.093225,0.092497,0.091744,0.090966,0.090164,0.089339,0.088490,0.087619,0.086725,0.085810,0.084874,0.083917,0.082940,0.081944,0.080930,0.079897,0.078847,0.077780,0.076696,0.075598,0.074484,0.073356,0.072215,0.071061,0.069895,0.068717,0.067529,0.066331,0.065124,0.063908,0.062684,0.061453,0.060217,0.058974,0.057727,0.056476,0.055221,0.053964,0.052706,0.051446,0.050186,0.048927,0.047669,0.046413,0.045160,0.043911,0.042666,0.041426,0.040192,0.038965,0.037745,0.036534,0.035331,0.034137,0.032954,0.031782,0.030622,0.029475,0.028340,0.027219,0.026113,0.025022,0.023947,0.022888,0.021846,0.020823,0.019817,0.018831,0.017864,0.016918,0.015992,0.015087,0.014205,0.013345,0.012508,0.011694,0.010904,0.010139,0.009398,0.008683,0.007993,0.007330,0.006694,0.006084,0.005502,0.004947,0.004421,0.003922,0.003453,0.003012,0.002601,0.002219,0.001867,0.001544,0.001252,0.000990,0.000759,0.000558,0.000388,0.000248,0.000140,0.000062,0.000016,0.000000};

/* Table of Trigonometric function */
DTYPE _sintbl[256-64+1]={0.000000,0.024541,0.049068,0.073565,0.098017,0.122411,0.146730,0.170962,0.195090,0.219101,0.242980,0.266713,0.290285,0.313682,0.336890,0.359895,0.382683,0.405241,0.427555,0.449611,0.471397,0.492898,0.514103,0.534998,0.555570,0.575808,0.595699,0.615232,0.634393,0.653173,0.671559,0.689541,0.707107,0.724247,0.740951,0.757209,0.773010,0.788346,0.803208,0.817585,0.831470,0.844854,0.857729,0.870087,0.881921,0.893224,0.903989,0.914210,0.923880,0.932993,0.941544,0.949528,0.956940,0.963776,0.970031,0.975702,0.980785,0.985278,0.989177,0.992480,0.995185,0.997290,0.998795,0.999699,1.000000,0.999699,0.998795,0.997290,0.995185,0.992480,0.989177,0.985278,0.980785,0.975702,0.970031,0.963776,0.956940,0.949528,0.941544,0.932993,0.923880,0.914210,0.903989,0.893224,0.881921,0.870087,0.857729,0.844854,0.831470,0.817585,0.803208,0.788346,0.773010,0.757209,0.740951,0.724247,0.707107,0.689541,0.671559,0.653173,0.634393,0.615232,0.595699,0.575808,0.555570,0.534998,0.514103,0.492898,0.471397,0.449611,0.427555,0.405241,0.382683,0.359895,0.336890,0.313682,0.290285,0.266713,0.242980,0.219101,0.195090,0.170962,0.146730,0.122411,0.098017,0.073565,0.049068,0.024541,0.000000,-0.024541,-0.049068,-0.073565,-0.098017,-0.122411,-0.146730,-0.170962,-0.195090,-0.219101,-0.242980,-0.266713,-0.290285,-0.313682,-0.336890,-0.359895,-0.382683,-0.405241,-0.427555,-0.449611,-0.471397,-0.492898,-0.514103,-0.534998,-0.555570,-0.575808,-0.595699,-0.615232,-0.634393,-0.653173,-0.671559,-0.689541,-0.707107,-0.724247,-0.740951,-0.757209,-0.773010,-0.788346,-0.803208,-0.817585,-0.831470,-0.844854,-0.857729,-0.870087,-0.881921,-0.893224,-0.903989,-0.914210,-0.923880,-0.932993,-0.941544,-0.949528,-0.956940,-0.963776,-0.970031,-0.975702,-0.980785,-0.985278,-0.989177,-0.992480,-0.995185,-0.997290,-0.998795,-0.999699,-1.000000};


/* FFT for real sequence                          */
/* input                                          */
/*   pRe[128] : Real part of input sequence       */
/*   pIm[128] : Imaginary part of input sequence  */
/* output                                         */
/*   pRe[65] : Real part of output sequence       */
/*   pIm[65] : Imaginary part of output sequence  */
int FFTExec128(DTYPE *pRe,DTYPE *pIm)
{
  const IDX nRealFFTSize=256;
  const IDX nFFTSize=128;
  IDX       j, lmx, li;
  DTYPE     *_pX=NULL;
  DTYPE     *_pY=NULL;
  DTYPE     *pSin=NULL;
  DTYPE     *pCos=NULL;
  IDX       lf, lix;
  IDX       mv2, mm1;
  DTYPE     t1, t2;

  lf  = nRealFFTSize/nFFTSize;
  lmx = nFFTSize;
  for(;;) {
    lix =  lmx;
    lmx /= 2;
    if (lmx <= 1) break;
    pSin = _sintbl;
    pCos = _sintbl + nRealFFTSize/4;
    for (j=0; j<lmx; j++) {
      _pX = &pRe[j];
      _pY = &pIm[j];
      for (li=lix; li<=nFFTSize ; li+=lix) {
	t1           =  *(_pX) - *(_pX + lmx);
	t2           =  *(_pY) - *(_pY + lmx);
	*(_pX)       += *(_pX + lmx);
	*(_pY)       += *(_pY + lmx);
	*(_pX + lmx) =  *pCos * t1 + *pSin * t2;
	*(_pY + lmx) =  *pCos * t2 - *pSin * t1;
	_pX          += lix;
	_pY          += lix;
      }
      pSin += lf;
      pCos += lf;
    }
    lf += lf;
  }
  _pX = pRe;
  _pY = pIm;
  for (li=nFFTSize/2; li--; _pX+=2,_pY+=2) {
    t1         =  *(_pX) - *(_pX + 1);
    t2         =  *(_pY) - *(_pY + 1);
    *(_pX)     += *(_pX + 1);
    *(_pY)     += *(_pY + 1);
    *(_pX + 1) = t1;
    *(_pY + 1) = t2;
  }
  j   = 0;
  _pX = pRe;
  _pY = pIm;
  mv2 = nFFTSize / 2;
  mm1 = nFFTSize - 1;
  for (lmx=0; lmx<mm1; lmx++) {
    if ((li=lmx-j)<0) {
      t1          = *(_pX);
      t2          = *(_pY);
      *(_pX)      = *(_pX + li);
      *(_pY)      = *(_pY + li);
      *(_pX + li) = t1;
      *(_pY + li) = t2;
    }
    li = mv2;
    while (li<=j) {
      j  -= li;
      li /= 2;
    }
    j   += li;
    _pX =  pRe + j;
    _pY =  pIm + j;
  }

  return(0);
}
/* FFT for real sequence                          */
/* input                                          */
/*   pRe[256] : Real part of input sequence       */
/*   pIm[256] : don't care                        */
/* output                                         */
/*   pRe[129] : Real part of output sequence      */
/*   pIm[129] : Imaginary part of output sequence */
void RealFFTExec256(DTYPE *pRe,DTYPE *pIm)
{
  const IDX nRealFFTSize=256;
  const IDX nFFTSize=128;
  DTYPE _r[128];
  DTYPE _i[128];
  DTYPE dTempRe1=0;
  DTYPE dTempIm1=0;
  DTYPE dTempRe2=0;
  DTYPE dTempIm2=0;
  DTYPE dTempRe3=0;
  DTYPE dTempIm3=0;
  DTYPE *pSin=NULL;
  DTYPE *pCos=NULL;
  
  pSin = _sintbl;
  pCos = _sintbl + nRealFFTSize/4;

  for (IDX i=0;i<nFFTSize;i++) {
    _r[i]=pRe[2*i];
    _i[i]=pRe[2*i+1];
  }
  FFTExec128(_r,_i);
  
  for (IDX k=1;k<nFFTSize/2;k++) {
    dTempRe1=0.5+0.5*pSin[k];
    dTempIm1=    0.5*pCos[k];
    dTempRe2=_r[k]-_r[nFFTSize-k];
    dTempIm2=_i[k]+_i[nFFTSize-k];
    dTempRe3=dTempRe1*dTempRe2-dTempIm1*dTempIm2;
    dTempIm3=dTempRe1*dTempIm2+dTempRe2*dTempIm1;
    pRe[k         ]=_r[k         ]-dTempRe3;
    pIm[k         ]=_i[k         ]-dTempIm3;
    pRe[nFFTSize-k]=_r[nFFTSize-k]+dTempRe3;
    pIm[nFFTSize-k]=_i[nFFTSize-k]-dTempIm3;
  }
  pRe[0         ]= _r[0]+_i[0];
  pIm[0         ]= 0;
  pRe[nFFTSize/2]= _r[nFFTSize/2];
  pIm[nFFTSize/2]=-_i[nFFTSize/2];  
  pRe[nFFTSize  ]= _r[0]-_i[0];
  pIm[nFFTSize  ]= 0;  
}
